<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Quiz API UI</title>
</head>
<body>
    <div class="container">
        <div id="questions">
            <b>Existing Questions</b>
            <br>
            <table id="questionsTable"></table>
        </div>
        <div id="questionAdmin">
            <form id="formCreate" onsubmit="handleSubmit()">
                <b>Question Administration</b>
                <br>
                Select Operation:
                <br>
                <input type="radio" id="createQuestion" name="operation" value="createQuestion">
                <label for="createQuestion">Create Question</label>       
                <br>
                <input type="radio" id="updateQuestion" name="operation" value="updateQuestion">
                <label for="updateQuestion">Update Question</label>   
                <br>        
                <input type="radio" id="removeQuestion" name="operation" value="removeQuestion">
                <label for="removeQuestion">Remove Question</label>               
                <br><br>   
                Question
                <br>
                <input type="text" id="question" size="50">
                <br><br>

                    Answers
                    <br>
                    <input type="text" id="answer1" size="50">  
                    <br>
                    <input type="text" id="answer2" size="50">  
                    <br>
                    <input type="text" id="answer3" size="50">  
                    <br>
                    <input type="text" id="answer4" size="50">  
                    <br>
 
                <br><br>
                <button type="submit">Submit Request</button>
                <br>
            </form>
            
        </div>
    </div>

    <!-- this script is specifically for a feathersjs client -->
    <script src="https://unpkg.com/@feathersjs/client@^4.3.0/dist/feathers.js"></script>
    <!-- socket.io needs to be on front and back end for complete connection  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    
    <!-- CRUD functionality for quiz questions -->
    <script>
        // Socket.io setup, the api service is on port 3030 under the name ideas
        // you can access the ideas service on this port using http://127.0.0.1:3030/ideas
        const socket = io('http://localhost:3030');

        // Init feathers app, it will be referred to as app
        const app = feathers();

        // Register socket.io to talk to the server
        app.configure(feathers.socketio(socket));



        // FUNCTION: sendQuestion()
        // PURPOSE:
        //  An question has been entered into the html form and the user has pressed the submit button.
        //  This function is called to collect the input and send it to the server.
        // PARAMETERS:
        //  e - an Event triggered by user action
        // RETURN: void

        async function createQuestion(e) {
            // get the user info
            const question = document.getElementById('question');
            const answer1 = document.getElementById('answer1');
            const answer2 = document.getElementById('answer2');
            const answer3 = document.getElementById('answer3');
            const answer4 = document.getElementById('answer4');

            let answers = [answer1.value, answer2.value, answer3.value, answer4.value];

            // Create new question
            app.service('questions').create({
                question: question.value,
                answers: answers
            });

            // Clear inputs since the user submitted what they entered and can start a new entry
            question.value = '';
            answer1.value = '';
            answer2.value = '';
            answer3.value = '';
            answer4.value = '';
        }



        // FUNCTION: removeQuestion()
        // PURPOSE:
        //  An question has been entered into the html form and the user has pressed the submit button.
        //  This function is called to collect the input and send it to the server.
        // PARAMETERS:
        //  e - an Event triggered by user action
        // RETURN: void

        async function removeQuestion() {
            table = document.getElementById("questionsTable");
            numberOfRows = table.rows.length;
            for (let i = 0; i < numberOfRows; i++) {
                const collection = table.rows[i].children[0].children;
                for (let item of collection) {
                    if (item.id.includes("question") && item.checked) {
                        
                        // Delete a question
                        app.service('questions').remove(item.id.match(/\d+/).toString());
                    }
                }
            }      
        }



        // FUNCTION: updateQuestion()
        // PURPOSE:
        //  An question has been entered into the html form and the user has pressed the submit button.
        //  This function is called to collect the input and send it to the server.
        // PARAMETERS:
        //  e - an Event triggered by user action
        // RETURN: void

        async function updateQuestion() {
            // get the user info
            const question = document.getElementById('question');
            const answer1 = document.getElementById('answer1');
            const answer2 = document.getElementById('answer2');
            const answer3 = document.getElementById('answer3');
            const answer4 = document.getElementById('answer4');

            let answers = [answer1.value, answer2.value, answer3.value, answer4.value];

            table = document.getElementById("questionsTable");
            numberOfRows = table.rows.length;
            const collection = document.getElementById("questions").children;
            let id;

            for (let i = 0; i < numberOfRows; i++) {
                const collection = table.rows[i].children[0].children;
                for (let item of collection) {
                    if (item.id.includes("question") && item.checked) {
                        id = item.id.match(/\d+/).toString();
                    }
                }
            }      


            // Create new question
            app.service('questions').update(
            id,
            {
                question: question.value,
                answers: answers
            });

            // Clear inputs since the user submitted what they entered and can start a new entry
            question.value = '';
            answer1.value = '';
            answer2.value = '';
            answer3.value = '';
            answer4.value = '';
        }



        // FUNCTION: renderQuestion()
        // PURPOSE:
        //  Each question in the questions array will be displayed on the website.
        //  This function receives a single question and appends html to the appropriate div.
        // PARAMETERS:
        //  idea - an Event triggered by user action
        // RETURN: void
        function renderQuestion(question) {
            // get the ideas div to append to and appendthe html
            document.getElementById('questionsTable').innerHTML += 
            `
                <tr>
                    <td>
                        <input id="question${question.id}" type="checkbox">
                    </td>
                    <td>
                    <p>${question.question}</p>
                    <ul>
                        <li>${question.answers[0]}</li>
                        <li>${question.answers[1]}</li>
                        <li>${question.answers[2]}</li>
                        <li>${question.answers[3]}</li>
                    </ul>
                    </td>                 
                </tr
            `;
        }



        // FUNCTION: renderQuestion()
        // PURPOSE:
        //  Each question in the questions array will be displayed on the website.
        //  This function receives a single question and appends html to the appropriate div.
        // PARAMETERS:
        //  idea - an Event triggered by user action
        // RETURN: void

        function getSelectedRadio() {
            let selected = document.querySelector('input[name="operation"]:checked');
            const question = document.getElementById("question");
            const answer1 = document.getElementById("answer1");
            const answer2 = document.getElementById("answer2");
            const answer3 = document.getElementById("answer3");
            const answer4 = document.getElementById("answer4");

            if (selected.value === "removeQuestion") {
                question.disabled = true;
                answer1.disabled = true;
                answer2.disabled = true;
                answer3.disabled = true;
                answer4.disabled = true;
            } 
            else {
                question.disabled = false;
                answer1.disabled = false;
                answer2.disabled = false;
                answer3.disabled = false;
                answer4.disabled = false;
            }

            if (selected.value === "updateQuestion") {
                table = document.getElementById("questionsTable");
                numberOfRows = table.rows.length;
                const collection = document.getElementById("questions").children;
                for (let i = 0; i < numberOfRows; i++) {
                    const collection = table.rows[i].children[0].children;
                    for (let item of collection) {
                        if (item.id.includes("question") && item.checked) {
                            const questionInfo = table.rows[i].children[1].children;
                            question.value = questionInfo[0].innerHTML;
                            const answerInfo = questionInfo[1].children;
                            answer1.value = answerInfo[0].innerHTML;
                            answer2.value = answerInfo[1].innerHTML;
                            answer3.value = answerInfo[2].innerHTML;
                            answer4.value = answerInfo[3].innerHTML;
                        }
                    }
                }    
                
            }
            else {
                question.value = "";
            }
        }


        // FUNCTION: renderQuestion()
        // PURPOSE:
        //  Each question in the questions array will be displayed on the website.
        //  This function receives a single question and appends html to the appropriate div.
        // PARAMETERS:
        //  idea - an Event triggered by user action
        // RETURN: void

        function handleSubmit() {
            let selected = document.querySelector('input[name="operation"]:checked');
            
            if (selected.value === "createQuestion") {
                createQuestion();
            } 
            else if (selected.value === "updateQuestion") {
                updateQuestion();
            }
            else {
                removeQuestion();
            }
        }



        // FUNCTION: init()
        // PURPOSE:
        //  This function 
        // PARAMETERS: void
        // RETURN: void
        async function init() {
            // the 
            const questions = await app.service('questions').find();

            // Add existing ideas to list
            questions.forEach(renderQuestion);

            // Add idea in realtime
            app.service('questions').on('created', renderQuestion);
        }

        init();
        let checkboxes = document.querySelectorAll("input[name=operation]");
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', getSelectedRadio);
        })
       

    </script>

</body>
</html>